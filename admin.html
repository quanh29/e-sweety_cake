<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω C·ª≠a h√†ng B√°nh Ng·ªçt</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f3f4f6;
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .sidebar-header {
            padding: 30px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h1 {
            font-size: 24px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-header p {
            font-size: 13px;
            opacity: 0.9;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            border-left: 4px solid transparent;
            color: rgba(255,255,255,0.9);
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.1);
            border-left-color: white;
        }

        .menu-item.active {
            background: rgba(255,255,255,0.15);
            border-left-color: white;
            color: white;
            font-weight: 600;
        }

        .menu-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            margin-left: 260px;
            flex: 1;
            padding: 30px;
        }

        .page-header {
            background: white;
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .page-header h2 {
            color: #1f2937;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .page-header p {
            color: #6b7280;
            font-size: 14px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .content-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 14px 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        tr:hover {
            background: #f9fafb;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background: white;
            /* wider modal for forms */
            max-width: 1000px;
            width: 90%;
            margin: 30px auto;
            padding: 30px;
            border-radius: 15px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #667eea;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-confirmed {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }

        .status-cancelled {
            background: #fee2e2;
            color: #991b1b;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .product-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }

        .search-bar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-bar input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-bar select {
            padding: 10px 15px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }

            .sidebar-header h1 {
                font-size: 20px;
            }

            .sidebar-header p,
            .menu-item span {
                display: none;
            }

            .menu-item {
                justify-content: center;
                padding: 15px;
            }

            .main-content {
                margin-left: 70px;
            }
        }
        /* Grid layout for item lists so headers and fields align */
        .items-grid {
            display: grid;
            /* make product column wider (3fr) and quantity column narrower (70px) */
            grid-template-columns: 3fr 120px 70px 140px 70px;
            gap: 8px;
            align-items: center;
        }

        .items-grid select,
        .items-grid input {
            width: 100%;
            box-sizing: border-box;
        }

        .items-grid .btn {
            justify-self: center;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>üç∞ Sweet Cake</h1>
                <p>H·ªá th·ªëng qu·∫£n l√Ω</p>
            </div>
            <div class="sidebar-menu">
                <div class="menu-item active" onclick="showTab('orders')">
                    <span class="menu-icon">üì¶</span>
                    <span>ƒê∆°n h√†ng</span>
                </div>
                <div class="menu-item" onclick="showTab('products')">
                    <span class="menu-icon">üßÅ</span>
                    <span>S·∫£n ph·∫©m</span>
                </div>
                <div class="menu-item" onclick="showTab('imports')">
                    <span class="menu-icon">üì•</span>
                    <span>Nh·∫≠p h√†ng</span>
                </div>
                <div class="menu-item" onclick="showTab('vouchers')">
                    <span class="menu-icon">üéüÔ∏è</span>
                    <span>Voucher</span>
                </div>
                <div class="menu-item" onclick="showTab('users')">
                    <span class="menu-icon">üë•</span>
                    <span>Ng∆∞·ªùi d√πng</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Tab ƒê∆°n h√†ng -->
            <div id="orders" class="tab-content active">
                <div class="page-header">
                    <h2>Qu·∫£n l√Ω ƒê∆°n h√†ng</h2>
                    <p>Theo d√µi v√† x·ª≠ l√Ω c√°c ƒë∆°n h√†ng t·ª´ kh√°ch h√†ng</p>
                </div>

                <div class="stats">
                    <div class="stat-card">
                        <h3>Ch·ªù x·ª≠ l√Ω</h3>
                        <div class="value" id="stat-pending">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>ƒê√£ x√°c nh·∫≠n</h3>
                        <div class="value" id="stat-confirmed">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>ƒê√£ giao</h3>
                        <div class="value" id="stat-completed">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>T·ªïng doanh thu</h3>
                        <div class="value" id="stat-revenue">0ƒë</div>
                    </div>
                </div>

                <div class="content-card">
                    <div class="search-bar">
                        <input type="text" id="search-order" placeholder="T√¨m ki·∫øm ƒë∆°n h√†ng..." onkeyup="searchOrders()">
                        <select id="filter-status" onchange="filterOrders()">
                            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                            <option value="pending">Ch·ªù x·ª≠ l√Ω</option>
                            <option value="confirmed">ƒê√£ x√°c nh·∫≠n</option>
                            <option value="completed">ƒê√£ giao</option>
                            <option value="cancelled">ƒê√£ h·ªßy</option>
                        </select>
                        <button class="btn btn-primary" onclick="openOrderModal()">+ Th√™m ƒë∆°n h√†ng</button>
                    </div>

                    <table id="orders-table">
                        <thead>
                            <tr>
                                <th>M√£ ƒë∆°n</th>
                                <th>Kh√°ch h√†ng</th>
                                <th>S·∫£n ph·∫©m</th>
                                <th>T·ªïng ti·ªÅn</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Ng√†y t·∫°o</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="orders-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Tab S·∫£n ph·∫©m -->
            <div id="products" class="tab-content">
                <div class="page-header">
                    <h2>Qu·∫£n l√Ω S·∫£n ph·∫©m</h2>
                    <p>Qu·∫£n l√Ω danh s√°ch c√°c lo·∫°i b√°nh trong c·ª≠a h√†ng</p>
                </div>

                <div class="content-card">
                    <div class="search-bar">
                        <input type="text" id="search-product" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..." onkeyup="searchProducts()">
                        <button class="btn btn-primary" onclick="openProductModal()">+ Th√™m s·∫£n ph·∫©m</button>
                    </div>

                    <table id="products-table">
                        <thead>
                            <tr>
                                <th>H√¨nh ·∫£nh</th>
                                <th>T√™n b√°nh</th>
                                <th>M√¥ t·∫£</th>
                                <th>S·ªë l∆∞·ª£ng t·ªìn</th>
                                <th>Gi√° b√°n</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="products-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Tab Nh·∫≠p h√†ng -->
            <div id="imports" class="tab-content">
                <div class="page-header">
                    <h2>Qu·∫£n l√Ω Nh·∫≠p h√†ng</h2>
                    <p>Qu·∫£n l√Ω c√°c ƒë∆°n nh·∫≠p h√†ng v√† c·∫≠p nh·∫≠t t·ªìn kho</p>
                </div>

                <div class="content-card">
                    <div class="search-bar">
                        <input type="text" id="search-import" placeholder="T√¨m ki·∫øm ƒë∆°n nh·∫≠p h√†ng..." onkeyup="searchImports()">
                        <button class="btn btn-primary" onclick="openImportModal()">+ Th√™m ƒë∆°n nh·∫≠p h√†ng</button>
                    </div>

                    <table id="imports-table">
                        <thead>
                            <tr>
                                <th>M√£ phi·∫øu</th>
                                <th>Lo·∫°i b√°nh</th>
                                <th>S·ªë l∆∞·ª£ng</th>
                                <th>ƒê∆°n gi√°</th>
                                <th>Th√†nh ti·ªÅn</th>
                                <th>Ph√≠ giao h√†ng</th>
                                <th>T·ªïng c·ªông</th>
                                <th>Ng√†y nh·∫≠p</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="imports-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Tab Voucher -->
            <div id="vouchers" class="tab-content">
                <div class="page-header">
                    <h2>Qu·∫£n l√Ω Voucher</h2>
                    <p>T·∫°o v√† qu·∫£n l√Ω c√°c m√£ gi·∫£m gi√° cho kh√°ch h√†ng</p>
                </div>

                <div class="content-card">
                    <div class="search-bar">
                        <input type="text" id="search-voucher" placeholder="T√¨m ki·∫øm voucher..." onkeyup="searchVouchers()">
                        <select id="filter-voucher-type" onchange="filterVouchers()">
                            <option value="">T·∫•t c·∫£ lo·∫°i</option>
                            <option value="percentage">Ph·∫ßn trƒÉm (%)</option>
                            <option value="fixed">Gi·∫£m c·ªë ƒë·ªãnh</option>
                        </select>
                        <button class="btn btn-primary" onclick="openVoucherModal()">+ Th√™m voucher</button>
                    </div>

                    <table id="vouchers-table">
                        <thead>
                            <tr>
                                <th>M√£ voucher</th>
                                <th>Lo·∫°i</th>
                                <th>Gi√° tr·ªã</th>
                                <th>S·ªë l∆∞·ª£ng</th>
                                <th>ƒê√£ d√πng</th>
                                <th>C√≤n l·∫°i</th>
                                <th>Hi·ªáu l·ª±c</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="vouchers-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Tab Ng∆∞·ªùi d√πng -->
            <div id="users" class="tab-content">
                <div class="page-header">
                    <h2>Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</h2>
                    <p>Qu·∫£n l√Ω t√†i kho·∫£n v√† ph√¢n quy·ªÅn ng∆∞·ªùi d√πng h·ªá th·ªëng</p>
                </div>

                <div class="content-card">
                    <div class="search-bar">
                        <input type="text" id="search-user" placeholder="T√¨m ki·∫øm ng∆∞·ªùi d√πng..." onkeyup="searchUsers()">
                        <select id="filter-user-role" onchange="filterUsers()">
                            <option value="">T·∫•t c·∫£ vai tr√≤</option>
                            <option value="admin">Admin</option>
                            <option value="manager">Manager</option>
                            <option value="staff">Nh√¢n vi√™n</option>
                        </select>
                        <select id="filter-user-status" onchange="filterUsers()">
                            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                            <option value="active">ƒêang ho·∫°t ƒë·ªông</option>
                            <option value="disabled">V√¥ hi·ªáu h√≥a</option>
                        </select>
                        <button class="btn btn-primary" onclick="openUserModal()">+ Th√™m ng∆∞·ªùi d√πng</button>
                    </div>

                    <table id="users-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>H·ªç v√† t√™n</th>
                                <th>T√™n ƒëƒÉng nh·∫≠p</th>
                                <th>Vai tr√≤</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Ng√†y t·∫°o</th>
                                <th>L·∫ßn ƒëƒÉng nh·∫≠p cu·ªëi</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="users-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal ƒê∆°n h√†ng -->
    <div id="order-modal" class="modal">
        <div class="modal-content">
            <h2 id="order-modal-title">Th√™m ƒë∆°n h√†ng m·ªõi</h2>
            <form id="order-form">
                <div class="form-group">
                    <label>T√™n kh√°ch h√†ng *</label>
                    <input type="text" id="order-customer" required>
                </div>
                <div class="form-group">
                    <label>S·ªë ƒëi·ªán tho·∫°i *</label>
                    <input type="tel" id="order-phone" required>
                </div>
                <div class="form-group">
                    <label>ƒê·ªãa ch·ªâ *</label>
                    <input type="text" id="order-address" required>
                </div>
                <div class="form-group">
                    <label>Danh s√°ch s·∫£n ph·∫©m *</label>
                    <div class="items-headers items-grid" style="font-weight:600; margin-bottom:6px;">
                        <div>S·∫£n ph·∫©m</div>
                        <div>ƒê∆°n gi√°</div>
                        <div>S·ªë l∆∞·ª£ng</div>
                        <div>Th√†nh ti·ªÅn</div>
                        <div></div>
                    </div>
                    <div id="order-items-container"></div>
                    <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addOrderItemRow()">Th√™m s·∫£n ph·∫©m</button>
                    </div>
                </div>
                <!-- Invoice Summary -->
                <div class="form-group">
                    <label>M√£ voucher (t√πy ch·ªçn)</label>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <input type="text" id="order-voucher-code" placeholder="Nh·∫≠p m√£ voucher (VD: SALE10, OFF50K)" style="flex:1;">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="applyOrderVoucher()">√Åp d·ª•ng</button>
                    </div>
                    <div id="order-voucher-msg" style="font-size:12px;color:#10b981;margin-top:4px;"></div>
                </div>
                
                <div class="invoice-summary" style="background:#f9fafb; padding:20px; border-radius:8px; margin:20px 0;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:12px; font-size:15px;">
                        <span style="color:#6b7280;">T·∫°m t√≠nh:</span>
                        <span id="order-subtotal" style="font-weight:500;">0‚Ç´</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:12px; font-size:15px;">
                        <span style="color:#6b7280;">Gi·∫£m gi√°:</span>
                        <span id="order-discount" style="font-weight:500; color:#ef4444;">-0‚Ç´</span>
                    </div>
                    <div style="border-top:2px solid #e5e7eb; padding-top:12px; display:flex; justify-content:space-between; font-size:18px;">
                        <span style="font-weight:600; color:#1f2937;">T·ªïng c·ªông:</span>
                        <span id="order-total" style="font-weight:700; color:#667eea;">0‚Ç´</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Ghi ch√∫</label>
                    <textarea id="order-note"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeOrderModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-primary">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal S·∫£n ph·∫©m -->
    <div id="product-modal" class="modal">
        <div class="modal-content">
            <h2 id="product-modal-title">Th√™m s·∫£n ph·∫©m m·ªõi</h2>
            <form id="product-form">
                <div class="form-group">
                    <label>T√™n b√°nh *</label>
                    <input type="text" id="product-name" required>
                </div>
                <div class="form-group">
                    <label>M√¥ t·∫£</label>
                    <textarea id="product-description"></textarea>
                </div>
                <div class="form-group">
                    <label>URL H√¨nh ·∫£nh</label>
                    <input type="text" id="product-image" placeholder="https://example.com/image.jpg">
                </div>
                <div class="form-group">
                    <label>S·ªë l∆∞·ª£ng t·ªìn *</label>
                    <input type="number" id="product-stock" min="0" value="0" required>
                </div>
                <div class="form-group">
                    <label>Gi√° b√°n *</label>
                    <input type="number" id="product-price" min="0" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-primary">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Nh·∫≠p h√†ng -->
    <div id="import-modal" class="modal">
        <div class="modal-content">
            <h2 id="import-modal-title">Th√™m ƒë∆°n nh·∫≠p h√†ng</h2>
            <form id="import-form">
                <div class="form-group">
                    <label>Danh s√°ch nh·∫≠p h√†ng *</label>
                    <div class="items-headers items-grid" style="font-weight:600; margin-bottom:6px;">
                        <div>S·∫£n ph·∫©m</div>
                        <div>ƒê∆°n gi√°</div>
                        <div>S·ªë l∆∞·ª£ng</div>
                        <div>Th√†nh ti·ªÅn</div>
                        <div></div>
                    </div>
                    <div id="import-items-container"></div>
                    <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addImportItemRow()">Th√™m h√†ng</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Ph√≠ giao h√†ng</label>
                    <input type="number" id="import-shipping" min="0" value="0" onchange="updateImportTotal()">
                </div>
                <!-- single import-total field preserved above -->
                <div class="form-group">
                    <label>T·ªïng c·ªông</label>
                    <input type="text" id="import-total" readonly>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeImportModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-primary">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Voucher -->
    <div id="voucher-modal" class="modal">
        <div class="modal-content">
            <h2 id="voucher-modal-title">Th√™m voucher m·ªõi</h2>
            <form id="voucher-form">
                <div class="form-group">
                    <label>M√£ voucher * (ch·ªØ hoa, kh√¥ng d·∫•u, kh√¥ng kho·∫£ng tr·∫Øng)</label>
                    <input type="text" id="voucher-code" required pattern="[A-Z0-9]+" style="text-transform:uppercase;" placeholder="VD: SALE10, OFF50K">
                </div>
                <div class="form-group">
                    <label>Lo·∫°i gi·∫£m gi√° *</label>
                    <select id="voucher-type" required onchange="updateVoucherValueLabel()">
                        <option value="">-- Ch·ªçn lo·∫°i --</option>
                        <option value="percentage">Ph·∫ßn trƒÉm (%)</option>
                        <option value="fixed">Gi·∫£m c·ªë ƒë·ªãnh (VNƒê)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label id="voucher-value-label">Gi√° tr·ªã *</label>
                    <input type="number" id="voucher-value" min="0" required>
                </div>
                <div class="form-group">
                    <label>S·ªë l∆∞·ª£ng *</label>
                    <input type="number" id="voucher-quantity" min="1" value="100" required>
                </div>
                <div class="form-group">
                    <label>Ng√†y b·∫Øt ƒë·∫ßu *</label>
                    <input type="date" id="voucher-start-date" required>
                </div>
                <div class="form-group">
                    <label>Ng√†y h·∫øt h·∫°n *</label>
                    <input type="date" id="voucher-end-date" required>
                </div>
                <div class="form-group">
                    <label>M√¥ t·∫£</label>
                    <textarea id="voucher-description" placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ voucher..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeVoucherModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-primary">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Ng∆∞·ªùi d√πng -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <h2 id="user-modal-title">Th√™m ng∆∞·ªùi d√πng m·ªõi</h2>
            <form id="user-form">
                <div class="form-group">
                    <label>H·ªç v√† t√™n *</label>
                    <input type="text" id="user-fullname" required placeholder="Nguy·ªÖn VƒÉn A">
                </div>
                <div class="form-group">
                    <label>T√™n ƒëƒÉng nh·∫≠p * (kh√¥ng d·∫•u, kh√¥ng kho·∫£ng tr·∫Øng)</label>
                    <input type="text" id="user-username" required pattern="[a-zA-Z0-9_]+" style="text-transform:lowercase;" placeholder="nguyenvana">
                </div>
                <div class="form-group">
                    <label id="user-password-label">M·∫≠t kh·∫©u *</label>
                    <input type="password" id="user-password" minlength="6" placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±">
                    <small style="color: #6b7280; font-size: 12px;">ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën thay ƒë·ªïi m·∫≠t kh·∫©u (khi s·ª≠a)</small>
                </div>
                <div class="form-group">
                    <label>Vai tr√≤ *</label>
                    <select id="user-role" required>
                        <option value="">-- Ch·ªçn vai tr√≤ --</option>
                        <option value="admin">Admin (To√†n quy·ªÅn)</option>
                        <option value="manager">Manager (Qu·∫£n l√Ω)</option>
                        <option value="staff">Nh√¢n vi√™n</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tr·∫°ng th√°i *</label>
                    <select id="user-status" required>
                        <option value="active">ƒêang ho·∫°t ƒë·ªông</option>
                        <option value="disabled">V√¥ hi·ªáu h√≥a</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="user-email" placeholder="email@example.com">
                </div>
                <div class="form-group">
                    <label>S·ªë ƒëi·ªán tho·∫°i</label>
                    <input type="tel" id="user-phone" placeholder="0912345678">
                </div>
                <div class="form-group">
                    <label>Ghi ch√∫</label>
                    <textarea id="user-note" placeholder="Ghi ch√∫ v·ªÅ ng∆∞·ªùi d√πng..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeUserModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-primary">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // D·ªØ li·ªáu m·∫´u
        let orders = [];
        let products = [
            {id: 1, name: 'B√°nh Tiramisu', description: 'B√°nh Tiramisu √ù truy·ªÅn th·ªëng', image: 'https://images.unsplash.com/photo-1571877227200-a0d98ea607e9?w=200', stock: 15, price: 250000},
            {id: 2, name: 'B√°nh Cheesecake', description: 'Cheesecake v·ªã d√¢u t√¢y', image: 'https://images.unsplash.com/photo-1533134486753-c833f0ed4866?w=200', stock: 20, price: 200000},
            {id: 3, name: 'B√°nh Chocolate', description: 'B√°nh chocolate ƒë·∫Øng', image: 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=200', stock: 10, price: 180000}
        ];
        let imports = [];
        let editingId = null;
        let editingType = '';
        // Vouchers array with full properties
        let vouchers = [
            {
                id: 1,
                code: 'SALE10',
                type: 'percentage',
                value: 10,
                quantity: 100,
                used: 5,
                startDate: new Date('2025-01-01'),
                endDate: new Date('2025-12-31'),
                description: 'Gi·∫£m 10% cho t·∫•t c·∫£ ƒë∆°n h√†ng'
            },
            {
                id: 2,
                code: 'OFF50K',
                type: 'fixed',
                value: 50000,
                quantity: 50,
                used: 10,
                startDate: new Date('2025-01-01'),
                endDate: new Date('2025-06-30'),
                description: 'Gi·∫£m 50,000ƒë cho ƒë∆°n h√†ng'
            }
        ];

        // Users array
        let users = [
            {
                id: 1,
                fullname: 'Nguy·ªÖn VƒÉn Admin',
                username: 'admin',
                password: 'admin123', // In real app, this should be hashed
                role: 'admin',
                status: 'active',
                email: 'admin@sweetcake.vn',
                phone: '0912345678',
                createdAt: new Date('2025-01-01'),
                lastLogin: new Date(),
                note: 'T√†i kho·∫£n qu·∫£n tr·ªã vi√™n h·ªá th·ªëng'
            },
            {
                id: 2,
                fullname: 'Tr·∫ßn Th·ªã Manager',
                username: 'manager01',
                password: 'manager123',
                role: 'manager',
                status: 'active',
                email: 'manager@sweetcake.vn',
                phone: '0987654321',
                createdAt: new Date('2025-01-15'),
                lastLogin: new Date('2025-10-16'),
                note: 'Qu·∫£n l√Ω c·ª≠a h√†ng'
            },
            {
                id: 3,
                fullname: 'L√™ VƒÉn Nh√¢n Vi√™n',
                username: 'staff01',
                password: 'staff123',
                role: 'staff',
                status: 'active',
                email: 'staff01@sweetcake.vn',
                phone: '0909123456',
                createdAt: new Date('2025-02-01'),
                lastLogin: new Date('2025-10-15'),
                note: ''
            }
        ];

        // Kh·ªüi t·∫°o
        function init() {
            renderOrders();
            renderProducts();
            renderImports();
            renderVouchers();
            renderUsers();
            updateStats();
            loadProductOptions();
        }

        // Tab management
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // ƒê∆°n h√†ng
        function renderOrders() {
            const tbody = document.getElementById('orders-body');
            const search = document.getElementById('search-order').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;

            let filtered = orders.filter(order => {
                const matchSearch = order.customer.toLowerCase().includes(search) || 
                                  order.id.toString().includes(search);
                const matchStatus = !statusFilter || order.status === statusFilter;
                return matchSearch && matchStatus;
            });

            tbody.innerHTML = filtered.map(order => {
                let productName = '';
                if (Array.isArray(order.items)) {
                    productName = order.items.map(it => `${it.name} x${it.quantity}`).join('<br>');
                } else {
                    const product = products.find(p => p.id === order.productId);
                    productName = product ? product.name + ' x' + order.quantity : 'N/A';
                }
                let statusClass = '';
                let statusText = '';
                switch(order.status) {
                    case 'pending':
                        statusClass = 'status-pending';
                        statusText = 'Ch·ªù x·ª≠ l√Ω';
                        break;
                    case 'confirmed':
                        statusClass = 'status-confirmed';
                        statusText = 'ƒê√£ x√°c nh·∫≠n';
                        break;
                    case 'completed':
                        statusClass = 'status-completed';
                        statusText = 'ƒê√£ giao';
                        break;
                    case 'cancelled':
                        statusClass = 'status-cancelled';
                        statusText = 'ƒê√£ h·ªßy';
                        break;
                }

                let actions = '';
                if (order.status === 'pending') {
                    actions = `
                        <button class="btn btn-warning btn-sm" onclick="editOrder(${order.id})">S·ª≠a</button>
                        <button class="btn btn-success btn-sm" onclick="confirmOrder(${order.id})">X√°c nh·∫≠n</button>
                        <button class="btn btn-danger btn-sm" onclick="cancelOrder(${order.id})">H·ªßy</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteOrder(${order.id})">X√≥a</button>
                    `;
                } else if (order.status === 'confirmed') {
                    actions = `
                        <button class="btn btn-success btn-sm" onclick="completeOrder(${order.id})">Ho√†n t·∫•t</button>
                        <button class="btn btn-danger btn-sm" onclick="cancelOrder(${order.id})">H·ªßy</button>
                    `;
                }

                return `
                    <tr>
                        <td>#${order.id}</td>
                        <td>
                            <div style="font-weight: 500;">${order.customer}</div>
                            <div style="font-size: 12px; color: #6b7280;">${order.phone}</div>
                        </td>
                        <td>
                            <div>${productName} x${order.quantity}</div>
                        </td>
                        <td style="font-weight: 500;">${formatCurrency(order.total)}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${formatDate(order.date)}</td>
                        <td>
                            <div class="action-buttons">
                                ${actions}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function openOrderModal(id = null) {
            editingId = id;
            editingType = 'order';
            const modal = document.getElementById('order-modal');
            const form = document.getElementById('order-form');
            
            if (id) {
                const order = orders.find(o => o.id === id);
                document.getElementById('order-modal-title').textContent = 'Ch·ªânh s·ª≠a ƒë∆°n h√†ng';
                document.getElementById('order-customer').value = order.customer;
                document.getElementById('order-phone').value = order.phone;
                document.getElementById('order-address').value = order.address;
                // populate items
                const container = document.getElementById('order-items-container');
                container.innerHTML = '';
                if (Array.isArray(order.items)) {
                    order.items.forEach(it => addOrderItemRow({productId: it.productId, quantity: it.quantity}));
                } else {
                    addOrderItemRow({productId: order.productId, quantity: order.quantity});
                }
                document.getElementById('order-note').value = order.note || '';
                // populate voucher fields if present
                if (document.getElementById('order-voucher-code')) document.getElementById('order-voucher-code').value = order.voucher || '';
                updateOrderTotal();
            } else {
                document.getElementById('order-modal-title').textContent = 'Th√™m ƒë∆°n h√†ng m·ªõi';
                form.reset();
                document.getElementById('order-items-container').innerHTML = '';
                addOrderItemRow();
            }
            
            modal.style.display = 'block';
        }

        function closeOrderModal() {
            document.getElementById('order-modal').style.display = 'none';
            editingId = null;
        }

        // Order: multi-item support
        function createProductOptionsHTML(selectedId) {
            const options = products.map(p =>
                `<option value="${p.id}" ${p.id === selectedId ? 'selected' : ''}>${p.name} - ${formatCurrency(p.price)}</option>`
            ).join('');
            return '<option value="">-- Ch·ªçn b√°nh --</option>' + options;
        }

        function parseCurrency(str) {
            if (!str) return 0;
            const num = parseInt(String(str).replace(/[^0-9-]/g, ''));
            return isNaN(num) ? 0 : num;
        }

        function addOrderItemRow(item = {}) {
            const container = document.getElementById('order-items-container');
            const idx = Date.now() + Math.random();
            const productId = item.productId || '';
            const quantity = item.quantity || 1;

            const row = document.createElement('div');
            row.className = 'order-item-row';
            row.style.marginBottom = '8px';
            row.dataset.idx = idx;

            row.innerHTML = `
                <div class="items-grid">
                    <select data-field="product" onchange="onOrderRowProductChange(this)">${createProductOptionsHTML(productId)}</select>
                    <input type="number" data-field="price" min="0" value="0" readonly>
                    <input type="number" data-field="quantity" min="1" value="${quantity}" onchange="updateOrderTotal()">
                    <input type="text" data-field="subtotal" readonly>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeOrderItemRow(this)">X√≥a</button>
                </div>
            `;

            container.appendChild(row);
            updateOrderTotal();
        }

        function onOrderRowProductChange(selectEl) {
            const pid = parseInt(selectEl.value);
            const product = products.find(p => p.id === pid);
            const row = selectEl.closest('.order-item-row');
            if (product && row) {
                const priceInput = row.querySelector('input[data-field="price"]');
                if (priceInput) priceInput.value = product.price;
            }
            updateOrderTotal();
        }

        function removeOrderItemRow(btn) {
            const row = btn.closest('.order-item-row');
            if (row) {
                row.remove();
                updateOrderTotal();
            }
        }

        function updateOrderTotal() {
            const container = document.getElementById('order-items-container');
            const rows = Array.from(container.querySelectorAll('.order-item-row'));
            let subtotal = 0;

            rows.forEach(row => {
                const productSelect = row.querySelector('select[data-field="product"]');
                const qtyInput = row.querySelector('input[data-field="quantity"]');
                const subtotalInput = row.querySelector('input[data-field="subtotal"]');

                const productId = parseInt(productSelect.value);
                const quantity = parseInt(qtyInput.value) || 0;
                const priceInput = row.querySelector('input[data-field="price"]');
                const unitPrice = priceInput ? parseInt(priceInput.value) || 0 : 0;

                const line = unitPrice * quantity;
                subtotalInput.value = formatCurrency(line);
                subtotal += line;
            });

            document.getElementById('order-subtotal').textContent = formatCurrency(subtotal);

            // apply voucher if any - updated to work with vouchers array
            const code = (document.getElementById('order-voucher-code').value || '').trim().toUpperCase();
            let discount = 0;
            const voucher = vouchers.find(v => v.code === code);
            
            if (code && voucher) {
                // Check if voucher is valid (date range and quantity)
                const now = new Date();
                const isValidDate = now >= new Date(voucher.startDate) && now <= new Date(voucher.endDate);
                const hasQuantity = voucher.used < voucher.quantity;
                
                if (!isValidDate) {
                    document.getElementById('order-voucher-msg').textContent = '‚úó Voucher ƒë√£ h·∫øt h·∫°n ho·∫∑c ch∆∞a c√≥ hi·ªáu l·ª±c';
                    document.getElementById('order-voucher-msg').style.color = '#ef4444';
                } else if (!hasQuantity) {
                    document.getElementById('order-voucher-msg').textContent = '‚úó Voucher ƒë√£ h·∫øt l∆∞·ª£t s·ª≠ d·ª•ng';
                    document.getElementById('order-voucher-msg').style.color = '#ef4444';
                } else {
                    // Valid voucher - calculate discount
                    if (voucher.type === 'percentage') {
                        discount = Math.round(subtotal * (voucher.value / 100));
                    } else {
                        discount = voucher.value;
                    }
                    document.getElementById('order-voucher-msg').textContent = `‚úì √Åp d·ª•ng m√£ ${code} th√†nh c√¥ng!`;
                    document.getElementById('order-voucher-msg').style.color = '#10b981';
                }
            } else {
                if (code) {
                    document.getElementById('order-voucher-msg').textContent = '‚úó M√£ kh√¥ng h·ª£p l·ªá';
                    document.getElementById('order-voucher-msg').style.color = '#ef4444';
                } else {
                    document.getElementById('order-voucher-msg').textContent = '';
                }
            }

            document.getElementById('order-discount').textContent = '-' + formatCurrency(discount);
            const total = subtotal - discount;
            document.getElementById('order-total').textContent = formatCurrency(total >= 0 ? total : 0);
        }

        function applyOrderVoucher() {
            // re-run total calc which will read voucher code
            updateOrderTotal();
        }

        document.getElementById('order-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const container = document.getElementById('order-items-container');
            const rows = Array.from(container.querySelectorAll('.order-item-row'));
            const items = rows.map(row => {
                const productId = parseInt(row.querySelector('select[data-field="product"]').value);
                const quantity = parseInt(row.querySelector('input[data-field="quantity"]').value) || 0;
                const product = products.find(p => p.id === productId);
                return {
                    productId: productId,
                    name: product ? product.name : 'N/A',
                    price: product ? product.price : 0,
                    quantity: quantity,
                    subtotal: (product ? product.price : 0) * quantity
                };
            }).filter(i => i.productId);

            const subtotal = items.reduce((s, it) => s + it.subtotal, 0);
            
            // Calculate discount from voucher code with validation
            const voucherCode = (document.getElementById('order-voucher-code').value || '').trim().toUpperCase();
            let discount = 0;
            let voucherUsed = null;
            
            if (voucherCode) {
                const voucher = vouchers.find(v => v.code === voucherCode);
                if (voucher) {
                    const now = new Date();
                    const isValidDate = now >= new Date(voucher.startDate) && now <= new Date(voucher.endDate);
                    const hasQuantity = voucher.used < voucher.quantity;
                    
                    if (isValidDate && hasQuantity) {
                        if (voucher.type === 'percentage') {
                            discount = Math.round(subtotal * (voucher.value / 100));
                        } else {
                            discount = voucher.value;
                        }
                        voucherUsed = voucher;
                    }
                }
            }
            
            const total = subtotal - discount;

            const orderData = {
                customer: document.getElementById('order-customer').value,
                phone: document.getElementById('order-phone').value,
                address: document.getElementById('order-address').value,
                voucher: voucherCode,
                discount: discount,
                items: items,
                total: total >= 0 ? total : 0,
                note: document.getElementById('order-note').value,
                status: 'pending',
                date: new Date()
            };

            if (editingId) {
                const index = orders.findIndex(o => o.id === editingId);
                orders[index] = {...orders[index], ...orderData};
            } else {
                orderData.id = orders.length > 0 ? Math.max(...orders.map(o => o.id)) + 1 : 1;
                orders.unshift(orderData);
                
                // Increment voucher usage counter for new orders
                if (voucherUsed) {
                    voucherUsed.used += 1;
                    renderVouchers();
                }
            }

            closeOrderModal();
            renderOrders();
            updateStats();
        });

        function editOrder(id) {
            openOrderModal(id);
        }

        function deleteOrder(id) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë∆°n h√†ng n√†y?')) {
                orders = orders.filter(o => o.id !== id);
                renderOrders();
                updateStats();
            }
        }

        function confirmOrder(id) {
            const order = orders.find(o => o.id === id);
            order.status = 'confirmed';
            renderOrders();
            updateStats();
        }

        function completeOrder(id) {
            const order = orders.find(o => o.id === id);
            order.status = 'completed';
            renderOrders();
            updateStats();
        }

        function cancelOrder(id) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ƒë∆°n h√†ng n√†y?')) {
                const order = orders.find(o => o.id === id);
                order.status = 'cancelled';
                renderOrders();
                updateStats();
            }
        }

        function searchOrders() {
            renderOrders();
        }

        function filterOrders() {
            renderOrders();
        }

        // S·∫£n ph·∫©m
        function renderProducts() {
            const tbody = document.getElementById('products-body');
            const search = document.getElementById('search-product').value.toLowerCase();

            let filtered = products.filter(product => 
                product.name.toLowerCase().includes(search)
            );

            tbody.innerHTML = filtered.map(product => `
                <tr>
                    <td><img src="${product.image}" class="product-image" alt="${product.name}"></td>
                    <td style="font-weight: 500;">${product.name}</td>
                    <td>${product.description}</td>
                    <td><span style="font-weight: 500;">${product.stock}</span> c√°i</td>
                    <td style="font-weight: 500;">${formatCurrency(product.price)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-warning btn-sm" onclick="editProduct(${product.id})">S·ª≠a</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteProduct(${product.id})">X√≥a</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function openProductModal(id = null) {
            editingId = id;
            editingType = 'product';
            const modal = document.getElementById('product-modal');
            const form = document.getElementById('product-form');
            
            if (id) {
                const product = products.find(p => p.id === id);
                document.getElementById('product-modal-title').textContent = 'Ch·ªânh s·ª≠a s·∫£n ph·∫©m';
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-description').value = product.description;
                document.getElementById('product-image').value = product.image;
                document.getElementById('product-stock').value = product.stock;
                document.getElementById('product-price').value = product.price;
            } else {
                document.getElementById('product-modal-title').textContent = 'Th√™m s·∫£n ph·∫©m m·ªõi';
                form.reset();
            }
            
            modal.style.display = 'block';
        }

        function closeProductModal() {
            document.getElementById('product-modal').style.display = 'none';
            editingId = null;
        }

        document.getElementById('product-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productData = {
                name: document.getElementById('product-name').value,
                description: document.getElementById('product-description').value,
                image: document.getElementById('product-image').value || 'https://images.unsplash.com/photo-1586985289688-ca3cf47d3e6e?w=200',
                stock: parseInt(document.getElementById('product-stock').value),
                price: parseInt(document.getElementById('product-price').value)
            };

            if (editingId) {
                const index = products.findIndex(p => p.id === editingId);
                products[index] = {...products[index], ...productData};
            } else {
                productData.id = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
                products.push(productData);
            }

            closeProductModal();
            renderProducts();
            loadProductOptions();
        });

        function editProduct(id) {
            openProductModal(id);
        }

        function deleteProduct(id) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) {
                products = products.filter(p => p.id !== id);
                renderProducts();
                loadProductOptions();
            }
        }

        function searchProducts() {
            renderProducts();
        }

        // Nh·∫≠p h√†ng
        function renderImports() {
            const tbody = document.getElementById('imports-body');
            const search = document.getElementById('search-import').value.toLowerCase();

            let filtered = imports.filter(imp => 
                imp.id.toString().includes(search)
            );

            tbody.innerHTML = filtered.map(imp => {
                const product = products.find(p => p.id === imp.productId);
                const productName = product ? product.name : 'N/A';

                return `
                    <tr>
                        <td>#NH${imp.id}</td>
                        <td style="font-weight: 500;">${productName}</td>
                        <td>${imp.quantity} c√°i</td>
                        <td>${formatCurrency(imp.price)}</td>
                        <td>${formatCurrency(imp.subtotal)}</td>
                        <td>${formatCurrency(imp.shipping)}</td>
                        <td><strong>${formatCurrency(imp.total)}</strong></td>
                        <td>${formatDate(imp.date)}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-warning btn-sm" onclick="editImport(${imp.id})">S·ª≠a</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteImport(${imp.id})">X√≥a</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function openImportModal(id = null) {
            editingId = id;
            editingType = 'import';
            const modal = document.getElementById('import-modal');
            const form = document.getElementById('import-form');
            
            if (id) {
                const imp = imports.find(i => i.id === id);
                document.getElementById('import-modal-title').textContent = 'Ch·ªânh s·ª≠a ƒë∆°n nh·∫≠p h√†ng';
                const container = document.getElementById('import-items-container');
                container.innerHTML = '';
                if (Array.isArray(imp.items)) {
                    imp.items.forEach(it => addImportItemRow(it));
                } else {
                    addImportItemRow({productId: imp.productId, quantity: imp.quantity, price: imp.price});
                }
                document.getElementById('import-shipping').value = imp.shipping || 0;
                updateImportTotal();
            } else {
                document.getElementById('import-modal-title').textContent = 'Th√™m ƒë∆°n nh·∫≠p h√†ng';
                form.reset();
                document.getElementById('import-shipping').value = 0;
                document.getElementById('import-items-container').innerHTML = '';
                addImportItemRow();
            }
            
            modal.style.display = 'block';
        }

        function closeImportModal() {
            document.getElementById('import-modal').style.display = 'none';
            editingId = null;
        }

        function updateImportTotal() {
            const container = document.getElementById('import-items-container');
            const rows = Array.from(container.querySelectorAll('.import-item-row'));
            const shipping = parseInt(document.getElementById('import-shipping').value) || 0;

            let subtotal = 0;
            rows.forEach(row => {
                const productId = parseInt(row.querySelector('select[data-field="product"]').value);
                const qty = parseInt(row.querySelector('input[data-field="quantity"]').value) || 0;
                const price = parseInt(row.querySelector('input[data-field="price"]').value) || 0;
                const line = qty * price;
                row.querySelector('input[data-field="subtotal"]').value = formatCurrency(line);
                subtotal += line;
            });

            const total = subtotal + shipping;
            // write subtotal somewhere if needed (we removed single subtotal field)
            document.getElementById('import-total').value = formatCurrency(total);
        }

        document.getElementById('import-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const container = document.getElementById('import-items-container');
            const rows = Array.from(container.querySelectorAll('.import-item-row'));
            const shipping = parseInt(document.getElementById('import-shipping').value) || 0;

            const items = rows.map(row => {
                const productId = parseInt(row.querySelector('select[data-field="product"]').value);
                const quantity = parseInt(row.querySelector('input[data-field="quantity"]').value) || 0;
                const price = parseInt(row.querySelector('input[data-field="price"]').value) || 0;
                return { productId, quantity, price, subtotal: quantity * price };
            }).filter(i => i.productId && i.quantity > 0);

            const subtotal = items.reduce((s, it) => s + it.subtotal, 0);
            const total = subtotal + shipping;

            const importData = {
                items: items,
                subtotal: subtotal,
                shipping: shipping,
                total: total,
                date: new Date()
            };

            if (editingId) {
                const index = imports.findIndex(i => i.id === editingId);
                imports[index] = {...imports[index], ...importData};
            } else {
                importData.id = imports.length > 0 ? Math.max(...imports.map(i => i.id)) + 1 : 1;
                imports.unshift(importData);

                // update stocks for each imported item
                items.forEach(it => {
                    const product = products.find(p => p.id === it.productId);
                    if (product) product.stock += it.quantity;
                });
                renderProducts();
            }

            closeImportModal();
            renderImports();
        });

        function editImport(id) {
            openImportModal(id);
        }

        function deleteImport(id) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë∆°n nh·∫≠p h√†ng n√†y?')) {
                imports = imports.filter(i => i.id !== id);
                renderImports();
            }
        }

        function searchImports() {
            renderImports();
        }

        // Voucher Management
        function renderVouchers() {
            const tbody = document.getElementById('vouchers-body');
            const search = document.getElementById('search-voucher').value.toLowerCase();
            const typeFilter = document.getElementById('filter-voucher-type').value;

            let filtered = vouchers.filter(voucher => {
                const matchSearch = voucher.code.toLowerCase().includes(search) || 
                                  (voucher.description && voucher.description.toLowerCase().includes(search));
                const matchType = !typeFilter || voucher.type === typeFilter;
                return matchSearch && matchType;
            });

            tbody.innerHTML = filtered.map(voucher => {
                const now = new Date();
                const startDate = new Date(voucher.startDate);
                const endDate = new Date(voucher.endDate);
                const isActive = now >= startDate && now <= endDate;
                const remaining = voucher.quantity - voucher.used;
                
                let statusClass = '';
                let statusText = '';
                if (!isActive) {
                    if (now < startDate) {
                        statusClass = 'status-pending';
                        statusText = 'Ch∆∞a k√≠ch ho·∫°t';
                    } else {
                        statusClass = 'status-cancelled';
                        statusText = 'H·∫øt h·∫°n';
                    }
                } else if (remaining <= 0) {
                    statusClass = 'status-cancelled';
                    statusText = 'H·∫øt l∆∞·ª£t';
                } else {
                    statusClass = 'status-completed';
                    statusText = 'ƒêang ho·∫°t ƒë·ªông';
                }

                const typeText = voucher.type === 'percentage' ? 'Ph·∫ßn trƒÉm' : 'C·ªë ƒë·ªãnh';
                const valueText = voucher.type === 'percentage' 
                    ? `${voucher.value}%` 
                    : formatCurrency(voucher.value);

                return `
                    <tr>
                        <td style="font-weight: 500; color: #667eea;">${voucher.code}</td>
                        <td>${typeText}</td>
                        <td style="font-weight: 500;">${valueText}</td>
                        <td>${voucher.quantity}</td>
                        <td>${voucher.used}</td>
                        <td style="font-weight: 500; color: ${remaining > 0 ? '#10b981' : '#ef4444'};">${remaining}</td>
                        <td style="font-size: 13px;">
                            ${formatDate(startDate)}<br/>
                            <span style="color: #6b7280;">ƒë·∫øn</span> ${formatDate(endDate)}
                        </td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-warning btn-sm" onclick="editVoucher(${voucher.id})">S·ª≠a</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteVoucher(${voucher.id})">X√≥a</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function openVoucherModal(id = null) {
            editingId = id;
            editingType = 'voucher';
            const modal = document.getElementById('voucher-modal');
            const form = document.getElementById('voucher-form');
            
            if (id) {
                const voucher = vouchers.find(v => v.id === id);
                document.getElementById('voucher-modal-title').textContent = 'Ch·ªânh s·ª≠a voucher';
                document.getElementById('voucher-code').value = voucher.code;
                document.getElementById('voucher-code').readOnly = true; // Don't allow changing code
                document.getElementById('voucher-type').value = voucher.type;
                document.getElementById('voucher-value').value = voucher.value;
                document.getElementById('voucher-quantity').value = voucher.quantity;
                
                // Format dates for input
                const startDate = new Date(voucher.startDate);
                const endDate = new Date(voucher.endDate);
                document.getElementById('voucher-start-date').value = startDate.toISOString().split('T')[0];
                document.getElementById('voucher-end-date').value = endDate.toISOString().split('T')[0];
                document.getElementById('voucher-description').value = voucher.description || '';
                
                updateVoucherValueLabel();
            } else {
                document.getElementById('voucher-modal-title').textContent = 'Th√™m voucher m·ªõi';
                form.reset();
                document.getElementById('voucher-code').readOnly = false;
                // Set default dates
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('voucher-start-date').value = today;
            }
            
            modal.style.display = 'block';
        }

        function closeVoucherModal() {
            document.getElementById('voucher-modal').style.display = 'none';
            editingId = null;
        }

        function updateVoucherValueLabel() {
            const type = document.getElementById('voucher-type').value;
            const label = document.getElementById('voucher-value-label');
            if (type === 'percentage') {
                label.textContent = 'Gi√° tr·ªã (%) *';
                document.getElementById('voucher-value').placeholder = 'VD: 10 (t∆∞∆°ng ƒë∆∞∆°ng 10%)';
                document.getElementById('voucher-value').max = 100;
            } else if (type === 'fixed') {
                label.textContent = 'Gi√° tr·ªã (VNƒê) *';
                document.getElementById('voucher-value').placeholder = 'VD: 50000';
                document.getElementById('voucher-value').removeAttribute('max');
            } else {
                label.textContent = 'Gi√° tr·ªã *';
            }
        }

        document.getElementById('voucher-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const code = document.getElementById('voucher-code').value.trim().toUpperCase();
            const type = document.getElementById('voucher-type').value;
            const value = parseFloat(document.getElementById('voucher-value').value);
            const quantity = parseInt(document.getElementById('voucher-quantity').value);
            const startDate = new Date(document.getElementById('voucher-start-date').value);
            const endDate = new Date(document.getElementById('voucher-end-date').value);
            const description = document.getElementById('voucher-description').value;

            // Validation
            if (endDate < startDate) {
                alert('Ng√†y h·∫øt h·∫°n ph·∫£i sau ng√†y b·∫Øt ƒë·∫ßu!');
                return;
            }

            if (type === 'percentage' && (value < 0 || value > 100)) {
                alert('Gi√° tr·ªã ph·∫ßn trƒÉm ph·∫£i t·ª´ 0 ƒë·∫øn 100!');
                return;
            }

            if (type === 'fixed' && value < 0) {
                alert('Gi√° tr·ªã gi·∫£m gi√° ph·∫£i l·ªõn h∆°n 0!');
                return;
            }

            // Check for duplicate code when creating new voucher
            if (!editingId) {
                const existingVoucher = vouchers.find(v => v.code === code);
                if (existingVoucher) {
                    alert('M√£ voucher ƒë√£ t·ªìn t·∫°i! Vui l√≤ng ch·ªçn m√£ kh√°c.');
                    return;
                }
            }

            const voucherData = {
                code: code,
                type: type,
                value: value,
                quantity: quantity,
                startDate: startDate,
                endDate: endDate,
                description: description
            };

            if (editingId) {
                const index = vouchers.findIndex(v => v.id === editingId);
                vouchers[index] = {...vouchers[index], ...voucherData};
            } else {
                voucherData.id = vouchers.length > 0 ? Math.max(...vouchers.map(v => v.id)) + 1 : 1;
                voucherData.used = 0;
                vouchers.push(voucherData);
            }

            closeVoucherModal();
            renderVouchers();
        });

        function editVoucher(id) {
            openVoucherModal(id);
        }

        function deleteVoucher(id) {
            const voucher = vouchers.find(v => v.id === id);
            if (voucher.used > 0) {
                if (!confirm(`Voucher "${voucher.code}" ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng ${voucher.used} l·∫ßn. B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a?`)) {
                    return;
                }
            } else {
                if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a voucher n√†y?')) {
                    return;
                }
            }
            
            vouchers = vouchers.filter(v => v.id !== id);
            renderVouchers();
        }

        function searchVouchers() {
            renderVouchers();
        }

        function filterVouchers() {
            renderVouchers();
        }

        // User Management
        function renderUsers() {
            const tbody = document.getElementById('users-body');
            const search = document.getElementById('search-user').value.toLowerCase();
            const roleFilter = document.getElementById('filter-user-role').value;
            const statusFilter = document.getElementById('filter-user-status').value;

            let filtered = users.filter(user => {
                const matchSearch = user.fullname.toLowerCase().includes(search) || 
                                  user.username.toLowerCase().includes(search) ||
                                  (user.email && user.email.toLowerCase().includes(search));
                const matchRole = !roleFilter || user.role === roleFilter;
                const matchStatus = !statusFilter || user.status === statusFilter;
                return matchSearch && matchRole && matchStatus;
            });

            tbody.innerHTML = filtered.map(user => {
                let roleClass = '';
                let roleText = '';
                switch(user.role) {
                    case 'admin':
                        roleClass = 'status-cancelled'; // Red for admin (powerful)
                        roleText = 'Admin';
                        break;
                    case 'manager':
                        roleClass = 'status-confirmed'; // Blue for manager
                        roleText = 'Manager';
                        break;
                    case 'staff':
                        roleClass = 'status-pending'; // Yellow for staff
                        roleText = 'Nh√¢n vi√™n';
                        break;
                }

                const statusClass = user.status === 'active' ? 'status-completed' : 'status-cancelled';
                const statusText = user.status === 'active' ? 'ƒêang ho·∫°t ƒë·ªông' : 'V√¥ hi·ªáu h√≥a';

                const toggleButton = user.status === 'active' 
                    ? `<button class="btn btn-warning btn-sm" onclick="toggleUserStatus(${user.id})">V√¥ hi·ªáu h√≥a</button>`
                    : `<button class="btn btn-success btn-sm" onclick="toggleUserStatus(${user.id})">K√≠ch ho·∫°t</button>`;

                return `
                    <tr style="${user.status === 'disabled' ? 'opacity: 0.6;' : ''}">
                        <td>#${user.id}</td>
                        <td>
                            <div style="font-weight: 500;">${user.fullname}</div>
                            ${user.email ? `<div style="font-size: 12px; color: #6b7280;">${user.email}</div>` : ''}
                        </td>
                        <td style="font-family: monospace; color: #667eea;">${user.username}</td>
                        <td><span class="status-badge ${roleClass}">${roleText}</span></td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td style="font-size: 13px;">${formatDate(user.createdAt)}</td>
                        <td style="font-size: 13px;">
                            ${user.lastLogin ? formatDate(user.lastLogin) : '<span style="color: #6b7280;">Ch∆∞a ƒëƒÉng nh·∫≠p</span>'}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-warning btn-sm" onclick="editUser(${user.id})">S·ª≠a</button>
                                ${toggleButton}
                                <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">X√≥a</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function openUserModal(id = null) {
            editingId = id;
            editingType = 'user';
            const modal = document.getElementById('user-modal');
            const form = document.getElementById('user-form');
            const passwordField = document.getElementById('user-password');
            const passwordLabel = document.getElementById('user-password-label');
            
            if (id) {
                const user = users.find(u => u.id === id);
                document.getElementById('user-modal-title').textContent = 'Ch·ªânh s·ª≠a ng∆∞·ªùi d√πng';
                document.getElementById('user-fullname').value = user.fullname;
                document.getElementById('user-username').value = user.username;
                document.getElementById('user-username').readOnly = true; // Don't allow changing username
                document.getElementById('user-role').value = user.role;
                document.getElementById('user-status').value = user.status;
                document.getElementById('user-email').value = user.email || '';
                document.getElementById('user-phone').value = user.phone || '';
                document.getElementById('user-note').value = user.note || '';
                
                // Password is optional when editing
                passwordField.required = false;
                passwordField.value = '';
                passwordLabel.textContent = 'M·∫≠t kh·∫©u m·ªõi (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)';
            } else {
                document.getElementById('user-modal-title').textContent = 'Th√™m ng∆∞·ªùi d√πng m·ªõi';
                form.reset();
                document.getElementById('user-username').readOnly = false;
                passwordField.required = true;
                passwordLabel.textContent = 'M·∫≠t kh·∫©u *';
            }
            
            modal.style.display = 'block';
        }

        function closeUserModal() {
            document.getElementById('user-modal').style.display = 'none';
            editingId = null;
        }

        document.getElementById('user-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const fullname = document.getElementById('user-fullname').value.trim();
            const username = document.getElementById('user-username').value.trim().toLowerCase();
            const password = document.getElementById('user-password').value;
            const role = document.getElementById('user-role').value;
            const status = document.getElementById('user-status').value;
            const email = document.getElementById('user-email').value.trim();
            const phone = document.getElementById('user-phone').value.trim();
            const note = document.getElementById('user-note').value.trim();

            // Check for duplicate username when creating new user
            if (!editingId) {
                const existingUser = users.find(u => u.username === username);
                if (existingUser) {
                    alert('T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i! Vui l√≤ng ch·ªçn t√™n kh√°c.');
                    return;
                }
                
                if (!password || password.length < 6) {
                    alert('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!');
                    return;
                }
            }

            const userData = {
                fullname: fullname,
                role: role,
                status: status,
                email: email,
                phone: phone,
                note: note
            };

            if (editingId) {
                const index = users.findIndex(u => u.id === editingId);
                // Only update password if provided
                if (password && password.length >= 6) {
                    userData.password = password;
                } else {
                    userData.password = users[index].password; // Keep old password
                }
                users[index] = {...users[index], ...userData};
            } else {
                userData.id = users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1;
                userData.username = username;
                userData.password = password;
                userData.createdAt = new Date();
                userData.lastLogin = null;
                users.push(userData);
            }

            closeUserModal();
            renderUsers();
        });

        function editUser(id) {
            openUserModal(id);
        }

        function deleteUser(id) {
            const user = users.find(u => u.id === id);
            
            // Prevent deleting yourself or the last admin
            if (user.role === 'admin') {
                const adminCount = users.filter(u => u.role === 'admin' && u.status === 'active').length;
                if (adminCount <= 1) {
                    alert('Kh√¥ng th·ªÉ x√≥a admin cu·ªëi c√πng c·ªßa h·ªá th·ªëng!');
                    return;
                }
            }
            
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi d√πng "${user.fullname}"?`)) {
                return;
            }
            
            users = users.filter(u => u.id !== id);
            renderUsers();
        }

        function toggleUserStatus(id) {
            const user = users.find(u => u.id === id);
            
            // Prevent disabling yourself or the last admin
            if (user.status === 'active' && user.role === 'admin') {
                const activeAdminCount = users.filter(u => u.role === 'admin' && u.status === 'active').length;
                if (activeAdminCount <= 1) {
                    alert('Kh√¥ng th·ªÉ v√¥ hi·ªáu h√≥a admin cu·ªëi c√πng c·ªßa h·ªá th·ªëng!');
                    return;
                }
            }
            
            const newStatus = user.status === 'active' ? 'disabled' : 'active';
            const action = newStatus === 'disabled' ? 'v√¥ hi·ªáu h√≥a' : 'k√≠ch ho·∫°t';
            
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën ${action} ng∆∞·ªùi d√πng "${user.fullname}"?`)) {
                user.status = newStatus;
                renderUsers();
            }
        }

        function searchUsers() {
            renderUsers();
        }

        function filterUsers() {
            renderUsers();
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        function formatDate(date) {
            return new Date(date).toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function loadProductOptions() {
            const orderSelect = document.getElementById('order-product');
            const importSelect = document.getElementById('import-product');

            const options = products.map(p => 
                `<option value="${p.id}">${p.name} - ${formatCurrency(p.price)}</option>`
            ).join('');
            
            // keep legacy selects (if any) but also ensure row selects can be generated via createProductOptionsHTML
            if (orderSelect) orderSelect.innerHTML = '<option value="">-- Ch·ªçn b√°nh --</option>' + options;
            if (importSelect) importSelect.innerHTML = '<option value="">-- Ch·ªçn b√°nh --</option>' + options;
        }

        // import rows
        function addImportItemRow(item = {}) {
            const container = document.getElementById('import-items-container');
            const idx = Date.now() + Math.random();
            const productId = item.productId || '';
            const quantity = item.quantity || 1;
            const price = item.price || 0;

            const row = document.createElement('div');
            row.className = 'import-item-row';
            row.style.marginBottom = '8px';
            row.dataset.idx = idx;

            row.innerHTML = `
                <div class="items-grid">
                    <select data-field="product" onchange="onImportRowProductChange(this)">${createProductOptionsHTML(productId)}</select>
                    <input type="number" data-field="price" min="0" value="${price}" onchange="updateImportTotal()">
                    <input type="number" data-field="quantity" min="1" value="${quantity}" onchange="updateImportTotal()">
                    <input type="text" data-field="subtotal" readonly>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeImportItemRow(this)">X√≥a</button>
                </div>
            `;

            container.appendChild(row);
            updateImportTotal();
        }

        function removeImportItemRow(btn) {
            const row = btn.closest('.import-item-row');
            if (row) {
                row.remove();
                updateImportTotal();
            }
        }

        function onImportRowProductChange(selectEl) {
            // when product selected, preload price from products list
            const pid = parseInt(selectEl.value);
            const product = products.find(p => p.id === pid);
            const row = selectEl.closest('.import-item-row');
            if (product && row) {
                const priceInput = row.querySelector('input[data-field="price"]');
                if (priceInput && (!priceInput.value || parseInt(priceInput.value) === 0)) {
                    priceInput.value = product.price;
                }
            }
            updateImportTotal();
        }

        function updateStats() {
            const pending = orders.filter(o => o.status === 'pending').length;
            const confirmed = orders.filter(o => o.status === 'confirmed').length;
            const completed = orders.filter(o => o.status === 'completed').length;
            const revenue = orders
                .filter(o => o.status === 'completed')
                .reduce((sum, o) => sum + o.total, 0);

            document.getElementById('stat-pending').textContent = pending;
            document.getElementById('stat-confirmed').textContent = confirmed;
            document.getElementById('stat-completed').textContent = completed;
            document.getElementById('stat-revenue').textContent = formatCurrency(revenue);
        }

        // ƒê√≥ng modal khi click b√™n ngo√†i
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
                editingId = null;
            }
        }

        // Kh·ªüi t·∫°o ·ª©ng d·ª•ng
        init();
    </script>
</body>
</html>